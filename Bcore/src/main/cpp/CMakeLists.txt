# This file contains content generated by AI.
# AI-generated contents are not applicable for copyright nor warranty.

cmake_minimum_required(VERSION 3.10.2)

project("blackbox")

# Determine if building for 32-bit or 64-bit architecture
if(ANDROID_ABI STREQUAL "armeabi-v7a" OR ANDROID_ABI STREQUAL "x86")
    # Use prebuilt Dobby binaries for 32-bit architectures
    message(STATUS "Using prebuilt Dobby for 32-bit architecture: ${ANDROID_ABI}")
    
    # Import prebuilt Dobby library
    add_library(dobby STATIC IMPORTED)
    set_target_properties(dobby PROPERTIES
        IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/Dobby32/${ANDROID_ABI}/libdobby.a
    )
    
    # Set Dobby include directory for 32-bit
    set(DOBBY_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/Dobby32/include)
else()
    # Build Dobby from source for 64-bit architectures (arm64-v8a, x86_64)
    message(STATUS "Building Dobby from source for 64-bit architecture: ${ANDROID_ABI}")
    
    # Configure Dobby
    set(DOBBY_DEBUG OFF CACHE INTERNAL "")
    set(DOBBY_GENERATE_SHARED OFF CACHE INTERNAL "")
    set(Plugin.SymbolResolver ON CACHE INTERNAL "")
    set(Plugin.Android.BionicLinkerUtil OFF CACHE INTERNAL "")
    
    # Add Dobby64 subdirectory
    add_subdirectory(Dobby64 dobby_build)
    
    # Set Dobby include directory for 64-bit
    set(DOBBY_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/Dobby64/include)
endif()

# XDL library
add_library(xdl STATIC
    xdl/xdl.c
    xdl/xdl_iterate.c
    xdl/xdl_linker.c
    xdl/xdl_lzma.c
    xdl/xdl_util.c
)

target_include_directories(xdl PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})

# BlackBox library
add_library(blackbox SHARED
    BoxCore.cpp
    hidden_api.cpp
    IO.cpp
    Utils/elf_util.cpp
    Hook/DexFileHook.cpp
    Hook/FileSystemHook.cpp
    Utils/VirtualSpoof.cpp
    Utils/HexDump.cpp
    Utils/AntiDetection.cpp
    Hook/VMClassLoaderHook.cpp
    Hook/UnixFileSystemHook.cpp
    Hook/BinderHook.cpp
    Hook/BaseHook.cpp
    JniHook/JniHook.cpp
)

target_include_directories(blackbox PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${DOBBY_INCLUDE_DIR}
)

target_compile_options(blackbox PRIVATE
    -Wno-error=format-security
    -fvisibility=hidden
    -ffunction-sections
    -fdata-sections
    -w
    -std=c++17
    -Werror
    -fms-extensions
)

target_link_options(blackbox PRIVATE
    -Wl,--gc-sections,--strip-all,-z,max-page-size=16384
)

# Link libraries
target_link_libraries(blackbox
    dobby
    xdl
    log
    android
    z
)
