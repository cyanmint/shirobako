#!/bin/bash
# This file contains content generated by AI.
# AI-generated contents are not applicable for copyright nor warranty.

echo "Downloading QEMU user-mode static binaries and Android runtime libraries..."

# Create directories (only ARM architectures)
ASSETS_DIR="Bcore/src/main/assets"
mkdir -p "$ASSETS_DIR/qemu/arm64-v8a"
mkdir -p "$ASSETS_DIR/qemu/armeabi-v7a"
mkdir -p "$ASSETS_DIR/runtime/arm64-v8a"
mkdir -p "$ASSETS_DIR/runtime/armeabi-v7a"

# Create temporary directory
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

echo "Working in temporary directory: $TEMP_DIR"

# QEMU version to download (use Debian 12 version with actual static binaries)
QEMU_VERSION="7.2+dfsg-7+deb12u17"
QEMU_VERSION_ARMHF="7.2+dfsg-7+deb12u16"  # armhf uses slightly older version

###############################
# Download QEMU static binaries
###############################

echo "Downloading QEMU static binaries..."

# For arm64 host
echo "Downloading QEMU for arm64 host..."
if wget -q "http://ftp.debian.org/debian/pool/main/q/qemu/qemu-user-static_${QEMU_VERSION}_arm64.deb"; then
    echo "  Downloaded from ftp.debian.org"
elif wget -q "http://deb.debian.org/debian/pool/main/q/qemu/qemu-user-static_${QEMU_VERSION}_arm64.deb"; then
    echo "  Downloaded from deb.debian.org"
else
    echo "  Warning: Could not download QEMU for arm64"
fi

if [ -f "qemu-user-static_${QEMU_VERSION}_arm64.deb" ]; then
    ar x "qemu-user-static_${QEMU_VERSION}_arm64.deb"
    tar xf data.tar.xz
    if [ -f "usr/bin/qemu-arm-static" ]; then
        cp usr/bin/qemu-arm-static "$OLDPWD/$ASSETS_DIR/qemu/arm64-v8a/"
        echo "  ✓ Copied qemu-arm-static for arm64 host"
    fi
    rm -rf usr data.tar.xz control.tar.xz debian-binary "qemu-user-static_${QEMU_VERSION}_arm64.deb"
fi

# For armeabi-v7a host  
echo "Downloading QEMU for armeabi-v7a host..."
# Try with +b2 suffix first (armhf specific), then without
if wget -q "http://ftp.debian.org/debian/pool/main/q/qemu/qemu-user-static_${QEMU_VERSION_ARMHF}+b2_armhf.deb"; then
    echo "  Downloaded from ftp.debian.org (with +b2)"
    ARMHF_FILE="qemu-user-static_${QEMU_VERSION_ARMHF}+b2_armhf.deb"
elif wget -q "http://ftp.debian.org/debian/pool/main/q/qemu/qemu-user-static_${QEMU_VERSION_ARMHF}_armhf.deb"; then
    echo "  Downloaded from ftp.debian.org"
    ARMHF_FILE="qemu-user-static_${QEMU_VERSION_ARMHF}_armhf.deb"
elif wget -q "http://deb.debian.org/debian/pool/main/q/qemu/qemu-user-static_${QEMU_VERSION_ARMHF}_armhf.deb"; then
    echo "  Downloaded from deb.debian.org"
    ARMHF_FILE="qemu-user-static_${QEMU_VERSION_ARMHF}_armhf.deb"
else
    echo "  Warning: Could not download QEMU for armeabi-v7a"
    ARMHF_FILE=""
fi

if [ -n "$ARMHF_FILE" ] && [ -f "$ARMHF_FILE" ]; then
    ar x "$ARMHF_FILE"
    tar xf data.tar.xz
    if [ -f "usr/bin/qemu-aarch64-static" ]; then
        cp usr/bin/qemu-aarch64-static "$OLDPWD/$ASSETS_DIR/qemu/armeabi-v7a/"
        echo "  ✓ Copied qemu-aarch64-static for armeabi-v7a host"
    fi
    rm -rf usr data.tar.xz control.tar.xz debian-binary "$ARMHF_FILE"
fi

###############################
# Download Android runtime from redroid
###############################

echo "Downloading Android runtime from redroid container..."

# Check if docker is available
if ! command -v docker &> /dev/null; then
    echo "Warning: Docker not found, skipping Android runtime download"
    echo "QEMU binaries have been downloaded, but runtime libraries are missing"
    cd "$OLDPWD"
    rm -rf "$TEMP_DIR"
    exit 0
fi

# Pull redroid container
echo "Pulling redroid container (this may take a while)..."
if docker pull docker.io/redroid/redroid:16.0.0-latest; then
    echo "  ✓ Successfully pulled redroid container"
else
    echo "Warning: Failed to pull redroid container, skipping runtime download"
    cd "$OLDPWD"
    rm -rf "$TEMP_DIR"
    exit 0
fi

# Create temporary container
CONTAINER_ID=$(docker create docker.io/redroid/redroid:16.0.0-latest)
echo "Created temporary container: $CONTAINER_ID"

# Export container filesystem to access actual files (not symlinks)
echo "Extracting runtime files from container..."
EXPORT_TAR="$TEMP_DIR/redroid_export.tar"
docker export "$CONTAINER_ID" > "$EXPORT_TAR" 2>/dev/null

# Extract arm64 runtime from bootstrap directory
echo "Extracting arm64 runtime..."
if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/bin/bootstrap/linker64 2>/dev/null; then
    cp "$TEMP_DIR/system/bin/bootstrap/linker64" "$OLDPWD/$ASSETS_DIR/runtime/arm64-v8a/" && echo "  ✓ Copied linker64"
else
    echo "  ✗ linker64 not found in bootstrap"
fi

if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/lib64/bootstrap/libc.so 2>/dev/null; then
    cp "$TEMP_DIR/system/lib64/bootstrap/libc.so" "$OLDPWD/$ASSETS_DIR/runtime/arm64-v8a/" && echo "  ✓ Copied libc.so"
else
    echo "  ✗ libc.so not found in bootstrap"
fi

if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/lib64/bootstrap/libm.so 2>/dev/null; then
    cp "$TEMP_DIR/system/lib64/bootstrap/libm.so" "$OLDPWD/$ASSETS_DIR/runtime/arm64-v8a/" && echo "  ✓ Copied libm.so"
else
    echo "  ✗ libm.so not found in bootstrap"
fi

if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/lib64/bootstrap/libdl.so 2>/dev/null; then
    cp "$TEMP_DIR/system/lib64/bootstrap/libdl.so" "$OLDPWD/$ASSETS_DIR/runtime/arm64-v8a/" && echo "  ✓ Copied libdl.so"
else
    echo "  ✗ libdl.so not found in bootstrap"
fi

# Extract arm32 runtime from bootstrap directory
echo "Extracting arm32 runtime..."
if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/bin/bootstrap/linker 2>/dev/null; then
    cp "$TEMP_DIR/system/bin/bootstrap/linker" "$OLDPWD/$ASSETS_DIR/runtime/armeabi-v7a/" && echo "  ✓ Copied linker"
else
    echo "  ✗ linker not found in bootstrap"
fi

if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/lib/bootstrap/libc.so 2>/dev/null; then
    cp "$TEMP_DIR/system/lib/bootstrap/libc.so" "$OLDPWD/$ASSETS_DIR/runtime/armeabi-v7a/" && echo "  ✓ Copied libc.so"
else
    echo "  ✗ libc.so not found in bootstrap"
fi

if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/lib/bootstrap/libm.so 2>/dev/null; then
    cp "$TEMP_DIR/system/lib/bootstrap/libm.so" "$OLDPWD/$ASSETS_DIR/runtime/armeabi-v7a/" && echo "  ✓ Copied libm.so"
else
    echo "  ✗ libm.so not found in bootstrap"
fi

if tar -xf "$EXPORT_TAR" -C "$TEMP_DIR" system/lib/bootstrap/libdl.so 2>/dev/null; then
    cp "$TEMP_DIR/system/lib/bootstrap/libdl.so" "$OLDPWD/$ASSETS_DIR/runtime/armeabi-v7a/" && echo "  ✓ Copied libdl.so"
else
    echo "  ✗ libdl.so not found in bootstrap"
fi

# Clean up export tarball and container
rm -f "$EXPORT_TAR"
docker rm "$CONTAINER_ID" >/dev/null
echo "Cleaned up temporary container"

# Return to original directory
cd "$OLDPWD"
rm -rf "$TEMP_DIR"

echo ""
echo "Asset download complete!"
echo "QEMU binaries downloaded to: $ASSETS_DIR/qemu/"
echo "Runtime libraries downloaded to: $ASSETS_DIR/runtime/"

# List what was downloaded
echo ""
echo "Downloaded QEMU binaries:"
find "$ASSETS_DIR/qemu" -type f -name "qemu-*" -exec ls -lh {} \; || echo "No QEMU binaries found"

echo ""
echo "Downloaded runtime libraries:"
find "$ASSETS_DIR/runtime" -type f ! -name ".gitkeep" -exec ls -lh {} \; || echo "No runtime libraries found"

exit 0
